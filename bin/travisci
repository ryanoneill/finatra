#!/bin/bash

set -xe

function get_git_repo {
  git clone https://github.com/twitter/$1.git --branch develop --depth 1
}

function publish_local {
  $PROJECT_SBT ++$TRAVIS_SCALA_VERSION publishLocal
}

function publish_project_local {
  $PROJECT_SBT ++$TRAVIS_SCALA_VERSION $1/publishLocal
}

function dependency {
  cd $PROJECT_TMP_DIR
  get_git_repo $1
  cd $1
  publish_local
}

function project_dependency {
  cd $PROJECT_TMP_DIR
  get_git_repo $1
  cd $1
  publish_project_local $2
}

function clean_up {
  rm -rf $PROJECT_TMP_DIR
}

function setup {
  PROJECT_DIR=$(pwd)
  PROJECT_SBT=$PROJECT_DIR/sbt
  PROJECT_TMP_DIR=$(mktemp -d -t $1.XXXXXXXXXX.tmp)
}

function run {
  # Publish local dependencies when not in a master branch
  PROJECT_BRANCH=$(git rev-parse --abrev-ref HEAD)

  if [ "$PROJECT_BRANCH" != "master" ]; then
    setup finatra

    dependency util
    dependency ostrich
    project_dependency scrooge scrooge-core
    dependency finagle
    dependency twitter-server

    clean_up
  fi
}

run
